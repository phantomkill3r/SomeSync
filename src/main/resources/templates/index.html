<!DOCTYPE html>
<head>
    <title>Pusher Test</title>
    <div id="player"></div>
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script>
        var url = "http://127.0.0.1:9000/test";
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId: '',
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        function onPlayerReady(event) {
            player.cueVideoById('t2dPPR_JzwU', 0);
        }

        function onPlayerStateChange(event) {
            data = JSON.stringify({state: event.data, time: player.getCurrentTime()});
            states = [YT.PlayerState.PAUSED, YT.PlayerState.PLAYING];
            if (states.includes(event.data)) {
                $.ajax({
                    type: 'POST',
                    url: url,
                    contentType: 'application/json',
                    data: data
                })
            }
        }

        Pusher.logToConsole = false;
        var pusher = new Pusher('b0c7f76e11d1d09b4d50', {
            cluster: 'ap2'
        });
        var channel = pusher.subscribe('my-channel');
        channel.bind('my-event', function(data) {
            console.log(data);
            if (data.state == YT.PlayerState.PAUSED && player.getPlayerState() != YT.PlayerState.PAUSED) {
                player.pauseVideo();
                player.seekTo(data.time);
            } else if (data.state == YT.PlayerState.PLAYING && player.getPlayerState() != YT.PlayerState.PLAYING) {
                player.seekTo(data.time);
                player.playVideo();
            }
        });

    </script>
</head>